<form class="map-height-sidebar-form">
  <!-- Header Section -->
  <header class="map-height-header">
    <div class="flexrow">
      <h3><i class="fas fa-mountain"></i> {{localize "MAP_HEIGHT.ModuleTitle"}}</h3>
      <button type="button" class="map-height-edit-toggle {{#if isEditMode}}active{{/if}}" 
              data-action="toggle-edit-mode" 
              data-tooltip="{{localize 'MAP_HEIGHT.Tooltips.ActivateEditor'}}">
        <i class="fas fa-edit"></i>
        {{#if isEditMode}}
          {{localize "MAP_HEIGHT.Controls.HeightEditMode"}} (ON)
        {{else}}
          {{localize "MAP_HEIGHT.Controls.HeightEditMode"}} (OFF)
        {{/if}}
      </button>
    </div>
  </header>

  <!-- Brush Tools Section -->
  {{#if isEditMode}}
  <section class="map-height-brushes">
    <h4><i class="fas fa-paint-brush"></i> {{localize "MAP_HEIGHT.Controls.HeightBrush"}}</h4>
    
    <!-- Predefined Height Brushes -->
    <div class="map-height-brush-group">
      {{#each brushHeights}}
      <button type="button" 
              class="map-height-brush {{#if (eq @root.currentBrushHeight this.value)}}active{{/if}}"
              data-action="select-brush" 
              data-height="{{this.value}}"
              data-tooltip="{{this.label}} ({{this.value}})"
              style="border-color: {{this.color}};">
        <i class="{{this.icon}}"></i>
        <span>{{this.value}}</span>
      </button>
      {{/each}}
    </div>

    <!-- Custom Height Input -->
    <div class="map-height-custom-input">
      <label for="customHeight">{{localize "MAP_HEIGHT.Tooltips.CustomHeight"}}:</label>
      <div class="flexrow">
        <input type="number" 
               name="customHeight" 
               value="{{customHeight}}" 
               min="-1000" 
               max="1000" 
               step="1"
               placeholder="Custom height">
        <button type="button" 
                data-action="set-custom-height" 
                data-tooltip="{{localize 'MAP_HEIGHT.Dialog.CustomHeight.Apply'}}">
          <i class="fas fa-check"></i>
        </button>
      </div>
    </div>

    <!-- Current Brush Display -->
    <div class="current-brush-display">
      <strong>Current Brush: {{currentBrushHeight}}</strong>
    </div>
  </section>
  {{/if}}

  <!-- Settings Section -->
  <section class="map-height-settings">
    <h4><i class="fas fa-cog"></i> Settings</h4>
    
    <div class="form-group">
      <label class="checkbox">
        <input type="checkbox" name="autoUpdate" {{checked autoUpdate}}>
        {{localize "MAP_HEIGHT.Settings.AutoUpdateTokens.Name"}}
      </label>
      <p class="hint">{{localize "MAP_HEIGHT.Settings.AutoUpdateTokens.Hint"}}</p>
    </div>

    <div class="form-group">
      <label for="overlayOpacity">{{localize "MAP_HEIGHT.Settings.OverlayOpacity.Name"}}: {{overlayOpacity}}</label>
      <input type="range"
             name="overlayOpacity"
             min="0"
             max="1"
             step="0.1"
             value="{{overlayOpacity}}">
      <p class="hint">{{localize "MAP_HEIGHT.Settings.OverlayOpacity.Hint"}}</p>
    </div>

    <div class="form-group">
      <label for="fontSizeMultiplier">{{localize "MAP_HEIGHT.Settings.FontSizeMultiplier.Name"}}: {{fontSizeMultiplier}}</label>
      <input type="range"
             name="fontSizeMultiplier"
             min="1"
             max="5"
             step="0.5"
             value="{{fontSizeMultiplier}}">
      <p class="hint">{{localize "MAP_HEIGHT.Settings.FontSizeMultiplier.Hint"}}</p>
    </div>
  </section>

  <!-- Exception Management Section -->
  <section class="map-height-exceptions">
    <h4><i class="fas fa-plane"></i> {{localize "MAP_HEIGHT.Controls.ExceptionList"}}</h4>
    
    <div class="exception-controls">
      <button type="button" 
              data-action="add-exception" 
              data-tooltip="Add selected token(s) to exception list">
        <i class="fas fa-plus"></i>
        {{localize "MAP_HEIGHT.Dialog.ExceptionManagement.AddException"}}
      </button>
    </div>

    {{#if exceptionTokens}}
    <div class="exception-list">
      {{#each exceptionTokens}}
      <div class="map-height-exception-item">
        <div class="exception-info">
          <img src="{{this.img}}" alt="{{this.name}}" class="token-img">
          <div class="exception-details">
            <div class="map-height-exception-name">{{this.name}}</div>
            <div class="exception-actor">{{this.actor}}</div>
          </div>
        </div>
        <button type="button" 
                class="map-height-exception-remove" 
                data-action="remove-exception" 
                data-token-id="{{this.id}}"
                data-tooltip="{{localize 'MAP_HEIGHT.Dialog.ExceptionManagement.RemoveException'}}">
          <i class="fas fa-times"></i>
        </button>
      </div>
      {{/each}}
    </div>
    {{else}}
    <p class="no-exceptions">No flying units configured</p>
    {{/if}}
  </section>

  <!-- Data Management Section -->
  <section class="map-height-data-management">
    <h4><i class="fas fa-database"></i> Data Management</h4>
    
    <div class="data-controls">
      <button type="button" 
              data-action="export-data" 
              data-tooltip="Export height data to JSON file">
        <i class="fas fa-download"></i>
        Export Data
      </button>
      
      <button type="button" 
              data-action="import-data" 
              data-tooltip="Import height data from JSON file">
        <i class="fas fa-upload"></i>
        Import Data
      </button>
      
      <button type="button" 
              data-action="clear-all" 
              data-tooltip="Clear all height data"
              class="danger">
        <i class="fas fa-trash"></i>
        Clear All
      </button>
    </div>
  </section>

  <!-- Help Section -->
  <section class="map-height-help">
    <details>
      <summary><i class="fas fa-question-circle"></i> How to Use</summary>
      <div class="help-content">
        <ol>
          <li>Click "Height Edit Mode" to activate editing</li>
          <li>Select a brush height from the toolbar</li>
          <li>Click on grid squares to set their height</li>
          <li>Tokens will automatically update their elevation</li>
          <li>Add flying units to the exception list to prevent auto-updates</li>
        </ol>
      </div>
    </details>
  </section>
</form>